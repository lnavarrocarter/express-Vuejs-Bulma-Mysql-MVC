'use strict';

// 
var express = require('express');
var glob = require('glob');
var logger = require('morgan');
var cookieParser = require('cookie-parser');
var bodyParser = require('body-parser');
var compress = require('compression');
var methodOverride = require('method-override');
var cookieSession = require('cookie-session');
var helmet = require('helmet');
var csrf = require('csurf');
var validator = require('express-validator');
var expressVue = require('express-vue');
var oauth2Api = require('./api');
var path = require('path');

module.exports.init = function (app, config) {
    //Setup
    var env = process.env.NODE_ENV || 'development';
    var router = express.Router();
    var logType = 'dev';
    app.locals.ENV = env;
    app.locals.ENV_DEVELOPMENT = env === 'development';
    app.locals.rootPath = process.env.ROOT_PATH;

    //ExpressVue Setup
    //Latest non-production version of vue as of writing this doc, 
    //you can go to https://unpkg.com/vue/ to find the latest version
    //check the vuejs.org docs for more info
    var vueScript = 'https://unpkg.com/vue@2.4.2/dist/vue.js';

    if (process.env.NODE_ENV === 'production') {
        //its production so use the minimised production build of vuejs
        vueScript = 'https://unpkg.com/vue';
    }

    var vueOptions = {
        rootPath: path.join(__dirname, 'routes'),
        vue: {
            head: {
                meta: [{ script: vueScript }, { style: 'assets/rendered/style.css' }, { style: 'https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' }, { style: 'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.1/css/bulma.min.css' }, { style: 'https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.1/css/bulma.min.css.map' }]
            }
        }
    };
    var expressVueMiddleware = expressVue.init(vueOptions);
    app.use(expressVueMiddleware);

    //Security
    app.use(helmet());
    app.disable('x-powered-by');

    //Api
    var oauth2 = oauth2Api.init();
    app.use('/oauth2', oauth2);

    app.use(bodyParser.json());
    app.use(bodyParser.urlencoded({
        extended: true
    }));
    app.use(validator());

    app.use(compress());

    app.use(app.locals.rootPath, express.static(config.root));

    var sessionConfig = {
        secret: 'CHANGE_ME_TOKEN',
        name: 'session',
        keys: ['CHANGE_ME', 'ME_TOO_PLEASE'],
        resave: true,
        saveUninitialized: true,
        cookie: {
            domain: 'foo.bar.com',
            secure: false,
            httpOnly: true
        }
    };
    if (env === 'production') {
        app.set('trust proxy', 1);
        sessionConfig.cookie.secure = true;
        logType = 'combined';
    }

    if (env === 'development') {
        app.use(logger(logType));
    }

    app.use(cookieParser());

    app.use(methodOverride());

    app.use(cookieSession(sessionConfig));

    app.use(csrf({
        cookie: true
    }));

    app.use(function (req, res, next) {
        res.cookie('token', req.csrfToken(), {
            path: '/'
        });
        next();
    });

    app.use('/', router);

    var controllers = glob.sync(config.root + '/routes/**/*.js');
    controllers.forEach(function (controller) {
        module.require(controller).default(router);
    });

    app.use(function (req, res) {
        var data = {
            title: 'Error 404'
        };
        var vueOptions = {
            head: {
                title: 'Error 404'
            }
        };
        res.statusCode = 404;
        res.renderVue('error', data, vueOptions);
    });

    app.use(function onError(error, req, res, next) {
        res.statusCode = 500;
        var data = {
            debug: env === 'development',
            errorCode: error.code,
            error: error.stack
        };
        if (res.statusCode) {
            res.renderVue('error', data);
        } else {
            next();
        }
    });
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJvdXRlci5qcyJdLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsImdsb2IiLCJsb2dnZXIiLCJjb29raWVQYXJzZXIiLCJib2R5UGFyc2VyIiwiY29tcHJlc3MiLCJtZXRob2RPdmVycmlkZSIsImNvb2tpZVNlc3Npb24iLCJoZWxtZXQiLCJjc3JmIiwidmFsaWRhdG9yIiwiZXhwcmVzc1Z1ZSIsIm9hdXRoMkFwaSIsInBhdGgiLCJtb2R1bGUiLCJleHBvcnRzIiwiaW5pdCIsImFwcCIsImNvbmZpZyIsImVudiIsInByb2Nlc3MiLCJOT0RFX0VOViIsInJvdXRlciIsIlJvdXRlciIsImxvZ1R5cGUiLCJsb2NhbHMiLCJFTlYiLCJFTlZfREVWRUxPUE1FTlQiLCJyb290UGF0aCIsIlJPT1RfUEFUSCIsInZ1ZVNjcmlwdCIsInZ1ZU9wdGlvbnMiLCJqb2luIiwiX19kaXJuYW1lIiwidnVlIiwiaGVhZCIsIm1ldGEiLCJzY3JpcHQiLCJzdHlsZSIsImV4cHJlc3NWdWVNaWRkbGV3YXJlIiwidXNlIiwiZGlzYWJsZSIsIm9hdXRoMiIsImpzb24iLCJ1cmxlbmNvZGVkIiwiZXh0ZW5kZWQiLCJzdGF0aWMiLCJyb290Iiwic2Vzc2lvbkNvbmZpZyIsInNlY3JldCIsIm5hbWUiLCJrZXlzIiwicmVzYXZlIiwic2F2ZVVuaW5pdGlhbGl6ZWQiLCJjb29raWUiLCJkb21haW4iLCJzZWN1cmUiLCJodHRwT25seSIsInNldCIsInJlcSIsInJlcyIsIm5leHQiLCJjc3JmVG9rZW4iLCJjb250cm9sbGVycyIsInN5bmMiLCJmb3JFYWNoIiwiY29udHJvbGxlciIsImRlZmF1bHQiLCJkYXRhIiwidGl0bGUiLCJzdGF0dXNDb2RlIiwicmVuZGVyVnVlIiwib25FcnJvciIsImVycm9yIiwiZGVidWciLCJlcnJvckNvZGUiLCJjb2RlIiwic3RhY2siXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQSxJQUFNQSxVQUFVQyxRQUFRLFNBQVIsQ0FBaEI7QUFDQSxJQUFNQyxPQUFP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YTtBQUNmSSxrQkFBTTtBQUNGa0MsdUJBQU87QUFETDtBQURTLFNBQW5CO0FBS0FULFlBQUlVLFVBQUosR0FBaUIsR0FBakI7QUFDQVYsWUFBSVcsU0FBSixDQUFjLE9BQWQsRUFBdUJILElBQXZCLEVBQTZCckMsVUFBN0I7QUFDSCxLQVhEOztBQWFBZCxRQUFJdUIsR0FBSixDQUFRLFNBQVNnQyxPQUFULENBQWlCQyxLQUFqQixFQUF3QmQsR0FBeEIsRUFBNkJDLEdBQTdCLEVBQWtDQyxJQUFsQyxFQUF3QztBQUM1Q0QsWUFBSVUsVUFBSixHQUFpQixHQUFqQjtBQUNBLFlBQUlGLE9BQU87QUFDUE0sbUJBQU92RCxRQUFRLGFBRFI7QUFFUHdELHVCQUFXRixNQUFNRyxJQUZWO0FBR1BILG1CQUFPQSxNQUFNSTtBQUhOLFNBQVg7QUFLQSxZQUFJakIsSUFBSVUsVUFBUixFQUFvQjtBQUNoQlYsZ0JBQUlXLFNBQUosQ0FBYyxPQUFkLEVBQXVCSCxJQUF2QjtBQUNILFNBRkQsTUFFTztBQUNIUDtBQUNIO0FBQ0osS0FaRDtBQWNILENBbklEIiwiZmlsZSI6InJvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFxyXG5jb25zdCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xyXG5jb25zdCBnbG9iID0gcmVxdWlyZSgnZ2xvYicpO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCdtb3JnYW4nKTtcclxuY29uc3QgY29va2llUGFyc2VyID0gcmVxdWlyZSgnY29va2llLXBhcnNlcicpO1xyXG5jb25zdCBib2R5UGFyc2VyID0gcmVxdWlyZSgnYm9keS1wYXJzZXInKTtcclxuY29uc3QgY29tcHJlc3MgPSByZXF1aXJlKCdjb21wcmVzc2lvbicpO1xyXG5jb25zdCBtZXRob2RPdmVycmlkZSA9IHJlcXVpcmUoJ21ldGhvZC1vdmVycmlkZScpO1xyXG5jb25zdCBjb29raWVTZXNzaW9uID0gcmVxdWlyZSgnY29va2llLXNlc3Npb24nKTtcclxuY29uc3QgaGVsbWV0ID0gcmVxdWlyZSgnaGVsbWV0Jyk7XHJcbmNvbnN0IGNzcmYgPSByZXF1aXJlKCdjc3VyZicpO1xyXG5jb25zdCB2YWxpZGF0b3IgPSByZXF1aXJlKCdleHByZXNzLXZhbGlkYXRvcicpO1xyXG5jb25zdCBleHByZXNzVnVlID0gcmVxdWlyZSgnZXhwcmVzcy12dWUnKTtcclxuY29uc3Qgb2F1dGgyQXBpID0gcmVxdWlyZSgnLi9hcGknKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuXHJcbm1vZHVsZS5leHBvcnRzLmluaXQgPSAoYXBwLCBjb25maWcpID0+IHtcclxuICAgIC8vU2V0dXBcclxuICAgIGNvbnN0IGVudiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WIHx8ICdkZXZlbG9wbWVudCc7XHJcbiAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xyXG4gICAgbGV0IGxvZ1R5cGUgPSAnZGV2JztcclxuICAgIGFwcC5sb2NhbHMuRU5WID0gZW52O1xyXG4gICAgYXBwLmxvY2Fscy5FTlZfREVWRUxPUE1FTlQgPSAoZW52ID09PSAnZGV2ZWxvcG1lbnQnKTtcclxuICAgIGFwcC5sb2NhbHMucm9vdFBhdGggPSBwcm9jZXNzLmVudi5ST09UX1BBVEg7XHJcblxyXG4gICAgLy9FeHByZXNzVnVlIFNldHVwXHJcbiAgICAvL0xhdGVzdCBub24tcHJvZHVjdGlvbiB2ZXJzaW9uIG9mIHZ1ZSBhcyBvZiB3cml0aW5nIHRoaXMgZG9jLCBcclxuICAgIC8veW91IGNhbiBnbyB0byBodHRwczovL3VucGtnLmNvbS92dWUvIHRvIGZpbmQgdGhlIGxhdGVzdCB2ZXJzaW9uXHJcbiAgICAvL2NoZWNrIHRoZSB2dWVqcy5vcmcgZG9jcyBmb3IgbW9yZSBpbmZvXHJcbiAgICBsZXQgdnVlU2NyaXB0ID0gJ2h0dHBzOi8vdW5wa2cuY29tL3Z1ZUAyLjQuMi9kaXN0L3Z1ZS5qcyc7XHJcblxyXG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHtcclxuICAgICAgICAvL2l0cyBwcm9kdWN0aW9uIHNvIHVzZSB0aGUgbWluaW1pc2VkIHByb2R1Y3Rpb24gYnVpbGQgb2YgdnVlanNcclxuICAgICAgICB2dWVTY3JpcHQgPSAnaHR0cHM6Ly91bnBrZy5jb20vdnVlJztcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB2dWVPcHRpb25zID0ge1xyXG4gICAgICAgIHJvb3RQYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAncm91dGVzJyksXHJcbiAgICAgICAgdnVlOiB7XHJcbiAgICAgICAgICAgIGhlYWQ6IHtcclxuICAgICAgICAgICAgICAgIG1ldGE6IFtcclxuICAgICAgICAgICAgICAgICAgICB7IHNjcmlwdDogdnVlU2NyaXB0IH0sXHJcbiAgICAgICAgICAgICAgICAgICAgeyBzdHlsZTogJ2Fzc2V0cy9yZW5kZXJlZC9zdHlsZS5jc3MnIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgeyBzdHlsZTogJ2h0dHBzOi8vbWF4Y2RuLmJvb3RzdHJhcGNkbi5jb20vZm9udC1hd2Vzb21lLzQuNy4wL2Nzcy9mb250LWF3ZXNvbWUubWluLmNzcycgfSxcclxuICAgICAgICAgICAgICAgICAgICB7IHN0eWxlOiAnaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvYnVsbWEvMC42LjEvY3NzL2J1bG1hLm1pbi5jc3MnIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgeyBzdHlsZTogJ2h0dHBzOi8vY2RuanMuY2xvdWRmbGFyZS5jb20vYWpheC9saWJzL2J1bG1hLzAuNi4xL2Nzcy9idWxtYS5taW4uY3NzLm1hcCcgfSxcclxuICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBjb25zdCBleHByZXNzVnVlTWlkZGxld2FyZSA9IGV4cHJlc3NWdWUuaW5pdCh2dWVPcHRpb25zKTtcclxuICAgIGFwcC51c2UoZXhwcmVzc1Z1ZU1pZGRsZXdhcmUpO1xyXG5cclxuICAgIC8vU2VjdXJpdHlcclxuICAgIGFwcC51c2UoaGVsbWV0KCkpO1xyXG4gICAgYXBwLmRpc2FibGUoJ3gtcG93ZXJlZC1ieScpO1xyXG5cclxuICAgIC8vQXBpXHJcbiAgICBjb25zdCBvYXV0aDIgPSBvYXV0aDJBcGkuaW5pdCgpO1xyXG4gICAgYXBwLnVzZSgnL29hdXRoMicsIG9hdXRoMik7XHJcblxyXG4gICAgYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSk7XHJcbiAgICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7XHJcbiAgICAgICAgZXh0ZW5kZWQ6IHRydWVcclxuICAgIH0pKTtcclxuICAgIGFwcC51c2UodmFsaWRhdG9yKCkpO1xyXG5cclxuICAgIGFwcC51c2UoY29tcHJlc3MoKSk7XHJcblxyXG4gICAgYXBwLnVzZShhcHAubG9jYWxzLnJvb3RQYXRoLCBleHByZXNzLnN0YXRpYyhjb25maWcucm9vdCkpO1xyXG5cclxuICAgIGxldCBzZXNzaW9uQ29uZmlnID0ge1xyXG4gICAgICAgIHNlY3JldDogJ0NIQU5HRV9NRV9UT0tFTicsXHJcbiAgICAgICAgbmFtZTogJ3Nlc3Npb24nLFxyXG4gICAgICAgIGtleXM6IFtcclxuICAgICAgICAgICAgJ0NIQU5HRV9NRScsXHJcbiAgICAgICAgICAgICdNRV9UT09fUExFQVNFJ1xyXG4gICAgICAgIF0sXHJcbiAgICAgICAgcmVzYXZlOiB0cnVlLFxyXG4gICAgICAgIHNhdmVVbmluaXRpYWxpemVkOiB0cnVlLFxyXG4gICAgICAgIGNvb2tpZToge1xyXG4gICAgICAgICAgICBkb21haW46ICdmb28uYmFyLmNvbScsXHJcbiAgICAgICAgICAgIHNlY3VyZTogZmFsc2UsXHJcbiAgICAgICAgICAgIGh0dHBPbmx5OiB0cnVlLFxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBpZiAoZW52ID09PSAncHJvZHVjdGlvbicpIHtcclxuICAgICAgICBhcHAuc2V0KCd0cnVzdCBwcm94eScsIDEpO1xyXG4gICAgICAgIHNlc3Npb25Db25maWcuY29va2llLnNlY3VyZSA9IHRydWU7XHJcbiAgICAgICAgbG9nVHlwZSA9ICdjb21iaW5lZCc7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGVudiA9PT0gJ2RldmVsb3BtZW50Jykge1xyXG4gICAgICAgIGFwcC51c2UobG9nZ2VyKGxvZ1R5cGUpKTtcclxuICAgIH1cclxuXHJcbiAgICBhcHAudXNlKGNvb2tpZVBhcnNlcigpKTtcclxuXHJcbiAgICBhcHAudXNlKG1ldGhvZE92ZXJyaWRlKCkpO1xyXG5cclxuICAgIGFwcC51c2UoY29va2llU2Vzc2lvbihzZXNzaW9uQ29uZmlnKSk7XHJcblxyXG4gICAgYXBwLnVzZShjc3JmKHtcclxuICAgICAgICBjb29raWU6IHRydWVcclxuICAgIH0pKTtcclxuXHJcbiAgICBhcHAudXNlKGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgICAgIHJlcy5jb29raWUoJ3Rva2VuJywgcmVxLmNzcmZUb2tlbigpLCB7XHJcbiAgICAgICAgICAgIHBhdGg6ICcvJ1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG5leHQoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGFwcC51c2UoJy8nLCByb3V0ZXIpO1xyXG5cclxuICAgIGxldCBjb250cm9sbGVycyA9IGdsb2Iuc3luYyhjb25maWcucm9vdCArICcvcm91dGVzLyoqLyouanMnKTtcclxuICAgIGNvbnRyb2xsZXJzLmZvckVhY2goZnVuY3Rpb24gKGNvbnRyb2xsZXIpIHtcclxuICAgICAgICBtb2R1bGUucmVxdWlyZShjb250cm9sbGVyKS5kZWZhdWx0KHJvdXRlcik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBhcHAudXNlKChyZXEsIHJlcykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgICAgIHRpdGxlOiAnRXJyb3IgNDA0J1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgY29uc3QgdnVlT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgaGVhZDoge1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6ICdFcnJvciA0MDQnXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHJlcy5zdGF0dXNDb2RlID0gNDA0O1xyXG4gICAgICAgIHJlcy5yZW5kZXJWdWUoJ2Vycm9yJywgZGF0YSwgdnVlT3B0aW9ucyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBhcHAudXNlKGZ1bmN0aW9uIG9uRXJyb3IoZXJyb3IsIHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA1MDA7XHJcbiAgICAgICAgbGV0IGRhdGEgPSB7XHJcbiAgICAgICAgICAgIGRlYnVnOiBlbnYgPT09ICdkZXZlbG9wbWVudCcsXHJcbiAgICAgICAgICAgIGVycm9yQ29kZTogZXJyb3IuY29kZSxcclxuICAgICAgICAgICAgZXJyb3I6IGVycm9yLnN0YWNrXHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUpIHtcclxuICAgICAgICAgICAgcmVzLnJlbmRlclZ1ZSgnZXJyb3InLCBkYXRhKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBuZXh0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG59OyJdfQ==
